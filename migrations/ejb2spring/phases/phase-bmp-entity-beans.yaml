# Phase: BMP Entity Bean Migration
# Migrates Bean Managed Persistence entity beans to JPA entities with custom repository methods

migration-plan:
  phases:
    - id: "phase-bmp-entities"
      name: "BMP Entity Bean Migration"
      description: "Migrate Bean Managed Persistence (BMP) entity beans to JPA entities with custom repository implementations"
      
      tasks:
        - id: "task-bmp-migration"
          name: "Migrate BMP Entities to JPA"
          description: "Convert BMP entity beans to JPA entities, preserving custom SQL in repository methods"
          
          blocks:
            # Step 1: GRAPH_QUERY - Find all BMP entity beans
            - type: "GRAPH_QUERY"
              name: "query-bmp-entities"
              description: "Query all Bean Managed Persistence entity beans"
              query-type: "BY_TAGS"
              tags:
                - "ejb.bmp.entityBean"
              output-variable: "bmp_entities"
            
            # Step 2: OPENREWRITE - Apply automated refactorings
            - type: "OPENREWRITE"
              name: "refactor-bmp-annotations"
              description: "Remove EJB-specific annotations and prepare for JPA"
              recipe: "com.analyzer.ejb2spring.MigrateBMPEntity"
              file-pattern: "**/*.java"
              base-directory: "${project_root}/${artifact_id}/src/main/java"
            
            # Step 3: AI_ASSISTED_BATCH - Process each BMP entity with Amazon Q
            - type: "AI_ASSISTED_BATCH"
              name: "ai-migrate-bmp-entities"
              description: "AI-assisted migration for each BMP entity bean"
              input-nodes: "${bmp_entities}"
              prompt: |
                You are migrating a Bean Managed Persistence (BMP) EJB entity bean to a modern JPA entity with custom repository implementation.
                
                **Current BMP Entity:**
                - Node ID: ${current_node_id}
                - Class Name: ${current_node.className}
                - Package: ${current_node.packageName}
                
                **Migration Tasks:**
                
                1. **Convert BMP Entity to JPA Entity:**
                   - Add @Entity (jakarta.persistence) annotation
                   - Add @Table annotation with table name
                   - Convert fields to JPA fields with @Column annotations
                   - Add @Id and @GeneratedValue for primary key
                   - Remove EJB lifecycle methods (ejbCreate, ejbPostCreate, ejbActivate, ejbPassivate)
                   - Extract SQL from ejbLoad/ejbStore methods
                
                2. **Create Custom Repository Implementation:**
                   - Create repository interface extending JpaRepository<EntityName, PrimaryKeyType>
                   - Create custom repository implementation with preserved SQL logic from BMP methods
                   - Convert ejbLoad SQL to custom findById implementation if needed
                   - Convert ejbStore SQL to custom save implementation if needed
                   - Convert ejbFindByXXX methods to custom query methods
                   - Use JdbcTemplate or @Query with native SQL for complex queries
                
                3. **Preserve Business Logic:**
                   - Extract all SQL statements from BMP methods (ejbLoad, ejbStore, ejbFindXXX)
                   - Convert JDBC code to Spring JdbcTemplate or JPA native queries
                   - Maintain transaction boundaries
                   - Preserve error handling logic
                
                4. **Migration Guidelines:**
                   - Use Jakarta namespace (jakarta.persistence.*) not javax
                   - For complex SQL, use @Query with nativeQuery=true
                   - Consider using Spring Data JPA projections for optimized queries
                   - Document any SQL that couldn't be automatically converted
                
                **Expected Output:**
                - JPA entity class with proper annotations
                - Spring Data repository interface
                - Custom repository implementation class (if needed for complex SQL)
                - Updated service classes that reference this entity
                
                Please migrate this BMP entity bean following these guidelines, preserving all SQL logic.
              working-directory: "${project_root}"
              progress-message: "Migrating BMP entity"
              timeout-seconds: 600
            
            # Step 4: AI_ASSISTED - Compile and validate all changes
            - type: "AI_ASSISTED"
              name: "compile-bmp-entities"
              description: "Compile all migrated BMP entities and fix any compilation errors"
              prompt: |
                All BMP entities have been migrated to JPA entities with custom repositories.
                
                **Summary:**
                - Total entities processed: ${node_count}
                - Successful migrations: ${success_count}
                - Failed migrations: ${failure_count}
                
                **Tasks:**
                1. Run Maven compile to check for compilation errors
                2. Verify all SQL logic has been preserved in repository methods
                3. Check that JdbcTemplate is properly configured if used
                4. Ensure all custom repository implementations are wired correctly
                5. Fix any missing @Repository annotations
                6. Resolve any dependency injection issues
                
                Please compile the project and fix any errors related to the BMP-to-JPA migration.
              working-directory: "${project_root}"
              timeout-seconds: 300
            
            # Step 5: INTERACTIVE_VALIDATION - Human checkpoint
            - type: "INTERACTIVE_VALIDATION"
              name: "verify-bmp-migration"
              validation-type: "MANUAL_CONFIRM"
              message: |
                BMP Entity Bean migration completed.
                
                **Migration Summary:**
                - BMP entities processed: ${node_count}
                - Successful migrations: ${success_count}
                - Failed migrations: ${failure_count}
                
                **Review Checklist:**
                1. All BMP entities converted to JPA entities
                2. Custom SQL preserved in repository methods
                3. Repository interfaces and implementations created
                4. All entity classes compile successfully
                5. No javax.* imports remaining (all using jakarta.*)
                6. JdbcTemplate configured if used for native SQL
                7. Transaction management properly configured
                
                **Next Steps:**
                - Review custom SQL implementations
                - Test repository methods with actual database
                - Verify transaction boundaries
                - Compare query performance with original BMP implementation
                
                Please verify the BMP entity migration and confirm to proceed.
              required: true
              timeout-seconds: 1800
