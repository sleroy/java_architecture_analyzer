# Phase: CMP Entity Bean Migration
# Migrates Container Managed Persistence entity beans to JPA entities with Spring Data repositories

migration-plan:
  phases:
    - id: "phase-cmp-entities"
      name: "CMP Entity Bean Migration"
      description: "Migrate Container Managed Persistence (CMP) entity beans to JPA entities with Spring Data repositories"
      
      tasks:
        - id: "task-cmp-migration"
          name: "Migrate CMP Entities to JPA"
          description: "Convert CMP entity beans to modern JPA entities with proper annotations and relationships"
          
          blocks:
            # Step 1: GRAPH_QUERY - Find all CMP entity beans
            - type: "GRAPH_QUERY"
              name: "query-cmp-entities"
              description: "Query all Container Managed Persistence entity beans"
              query-type: "BY_TAGS"
              tags:
                - "ejb.cmp.entity_bean"
              output-variable: "cmp_entities"
            
            # Step 2: OPENREWRITE - Apply automated refactorings
            - type: "OPENREWRITE"
              name: "refactor-cmp-annotations"
              description: "Remove EJB-specific annotations and add JPA annotations"
              recipe: "com.analyzer.ejb2spring.MigrateCMPEntity"
              file-pattern: "**/*.java"
              base-directory: "${refactoring_project_path}/src/main/java"
            
            # Step 3: AI_ASSISTED_BATCH - Process each CMP entity
            - type: "AI_ASSISTED_BATCH"
              name: "ai-migrate-cmp-entities"
              description: "AI-assisted migration for each CMP entity bean"
              input-nodes: cmp_entities
              prompt: |
                You are migrating a Container Managed Persistence (CMP) EJB entity bean to a modern JPA entity with Spring Data repository.
                
                **CRITICAL - TARGET DIRECTORY:**
                **YOU MUST WRITE ALL FILES TO: ${refactoring_project_path}/src/main/java**
                **DO NOT write to the source project paths listed below - those are READ-ONLY references!**
                
                **Current Node Information:**
                - Node ID: ${current_node_id}
                - Class Name: ${current_node.simpleName}
                - Fully Qualified Name: ${current_node.fullyQualifiedName}
                - Package: ${current_node.packageName}
                - Node Type: ${current_node.nodeType}
                
                **Node Tags:**
                <#list current_node.tags as tag>
                - ${tag}
                </#list>
                
                **Node Properties:**
                <#list current_node.properties?keys as key>
                - ${key}: ${current_node.getPropertyToString(key)}
                </#list>
                
                **READ-ONLY Source Reference (for reading original code only):**
                <#assign primarySource = current_node.sourceAliasPaths?filter(path -> path?ends_with(".java") && !path?contains("/.analysis/"))?first!"">
                <#if primarySource?has_content>
                - Source to read: ${primarySource}
                </#if>
                
                **WRITE Target (where you MUST write the migrated files):**
                - Target directory: ${refactoring_project_path}/src/main/java
                - Entity file: ${refactoring_project_path}/src/main/java/${current_node.fullyQualifiedName?replace(".", "/")}.java
                - Repository interface: ${refactoring_project_path}/src/main/java/${current_node.packageName?replace(".", "/")}/repository/${current_node.simpleName}Repository.java
                
                ---
                
                <#-- Context-aware instructions based on node properties -->
                <#if current_node.hasProperty("cmp.fields")>
                <#assign cmpFields = current_node.getProperty("cmp.fields")>
                
                **üìã CMP FIELDS DETECTED:**
                This entity has ${cmpFields?size} container-managed fields:
                <#list cmpFields as field>
                - ${field.name} (${field.type})
                </#list>
                
                **Field Migration Instructions:**
                - Convert all CMP fields to JPA @Column annotated fields
                - Maintain proper Java types and column names
                - Add validation annotations if needed (@NotNull, @Size, etc.)
                </#if>
                
                <#if current_node.hasProperty("cmp.relationships")>
                <#assign relationships = current_node.getProperty("cmp.relationships")>
                
                **üîó CMR RELATIONSHIPS DETECTED:**
                This entity has ${relationships?size} container-managed relationships:
                <#list relationships as rel>
                - ${rel.fieldName}: ${rel.type} (${rel.cardinality})
                </#list>
                
                **Relationship Migration Instructions:**
                - Convert CMR relationships to JPA relationships
                - Use @OneToMany, @ManyToOne, @ManyToMany, @OneToOne as appropriate
                - Configure cascade types based on original EJB relationships
                - Add @JoinColumn or @JoinTable annotations
                - Use @JsonIgnore or @JsonManagedReference/@JsonBackReference for bidirectional relationships
                </#if>
                
                <#if current_node.hasProperty("ejb.primary_key.composite")>
                
                **‚ö†Ô∏è COMPOSITE PRIMARY KEY DETECTED:**
                - This entity uses a composite primary key
                - Create an @Embeddable key class or use @IdClass
                - Ensure proper equals() and hashCode() implementation
                </#if>
                
                <#if current_node.hasProperty("cmp.finder.methods")>
                <#assign finderMethods = current_node.getProperty("cmp.finder.methods")>
                
                **üîç FINDER METHODS DETECTED:**
                This entity has ${finderMethods?size} EJB-QL finder methods:
                <#list finderMethods as finder>
                - ${finder.name}
                </#list>
                
                **Finder Migration Instructions:**
                - Convert ejbSelectXXX methods to Spring Data query methods
                - Use method naming conventions (findByXXX, findAllByXXX)
                - Or use @Query annotation for complex queries
                - EJB-QL queries can often be converted to JPQL
                </#if>
                
                **Migration Tasks:**
                
                1. **Convert CMP Entity to JPA Entity:**
                   - Replace @Entity (javax.ejb) with @Entity (jakarta.persistence)
                   - Add @Table annotation with table name
                   - Convert all CMP fields to JPA @Column fields
                   - Add @Id and @GeneratedValue for primary key
                   - For composite keys, create @Embeddable class or use @IdClass
                   - Remove ALL EJB-specific methods (ejbCreate, ejbPostCreate, ejbLoad, ejbStore, ejbRemove)
                   - Remove EntityBean interface implementation
                   - Remove EntityContext field
                
                2. **Convert CMR Relationships to JPA:**
                   - Map one-to-many: @OneToMany(mappedBy = "parent", cascade = CascadeType.ALL)
                   - Map many-to-one: @ManyToOne with @JoinColumn
                   - Map many-to-many: @ManyToMany with @JoinTable
                   - Map one-to-one: @OneToOne with proper cascade
                   - Set appropriate fetch types (LAZY vs EAGER)
                   - Add orphanRemoval = true for composition relationships
                   - Use @JsonIgnore on back-references to prevent circular serialization
                
                3. **Create Spring Data JPA Repository:**
                   - Create repository interface extending JpaRepository<EntityName, PrimaryKeyType>
                   - Add custom query methods using method naming conventions
                   - For complex queries, use @Query with JPQL or native SQL
                   - Place repository in appropriate package (e.g., com.example.repository)
                   - Use query derivation: findByNameAndStatus(String name, String status)
                
                4. **Handle Finder Methods:**
                   - Convert ejbSelectXXX methods to repository query methods
                   - Use Spring Data method naming: findBy, findAllBy, countBy, existsBy
                   - Convert EJB-QL to JPQL for @Query annotations
                   - Use @Param for named parameters
                   - Add pagination with Pageable parameters if needed
                
                5. **Migration Guidelines:**
                   - Use Jakarta namespace (jakarta.persistence.*) not javax
                   - Follow JPA best practices for relationships
                   - Use proper cascade types (avoid CascadeType.ALL unless needed)
                   - Set fetch types appropriately (LAZY for collections)
                   - Add validation annotations (@NotNull, @Size, @Email, etc.)
                   - Document relationship ownership clearly
                   - Test bidirectional relationships carefully
                   - Ensure proper equals()/hashCode() using business keys, not IDs
                
                6. **IMPORTANT - No JPA/Hibernate Auto-Generation:**
                   - We are NOT using JPA/Hibernate for persistence operations
                   - JPA entities are used ONLY for structure and mapping
                   - Actual database operations use Spring JdbcTemplate
                   - Repository methods should use JdbcTemplate, not JPA methods
                
                **Expected Output:**
                - Updated JPA entity class with proper annotations
                - All CMP fields converted to @Column fields
                - All CMR relationships converted to JPA relationships
                - New Spring Data repository interface with query methods
                - Repository implementation using JdbcTemplate (not JPA)
                - No javax.* imports remaining (all using jakarta.*)
                - Updated service classes that use the repository
                
                Please migrate this CMP entity bean following these guidelines.
              working-directory: "${refactoring_project_path}/src/main/java"
              progress-message: "Migrating CMP entity"
              timeout-seconds: 600
            
            # Step 4: AI_ASSISTED - Compile and validate
            - type: "AI_ASSISTED"
              name: "compile-cmp-entities"
              description: "Compile all migrated CMP entities"
              prompt: |
                All CMP entities have been migrated to JPA entities with Spring Data repositories.
                
                **CRITICAL - WORKING DIRECTORY:**
                **You are working in the REFACTORING PROJECT at: ${refactoring_project_path}**
                **Run all Maven commands in: ${refactoring_project_path}**
                **DO NOT run commands in the source project!**
                
                **Summary:**
                - Total beans processed: ${node_count}
                
                **Class IDs:**
                <#list cmp_entities as bean>
                - ${bean}
                </#list>
                
                **Classes:**
                <#list cmp_entities_names as className>
                - ${className}
                </#list>
                
                **Tasks:**
                1. Run Maven compile in ${refactoring_project_path} to check for errors
                2. Fix any import issues (ensure using jakarta.persistence.* not javax.persistence.*)
                3. Resolve any missing dependencies in pom.xml
                4. Fix any JPA relationship configuration issues
                5. Verify all repository interfaces are properly configured
                6. Check @Column, @JoinColumn, and @JoinTable annotations
                7. Ensure proper cascade and fetch type configurations
                8. Test bidirectional relationships
                9. All files should be in ${refactoring_project_path}/src/main/java
                
                Please compile the classes in ${refactoring_project_path} and fix any errors.
              working-directory: "${refactoring_project_path}"
              timeout-seconds: 300
            
            # Step 5: INTERACTIVE_VALIDATION
            - type: "INTERACTIVE_VALIDATION"
              name: "verify-cmp-migration"
              validation-type: "MANUAL_CONFIRM"
              message: |
                CMP Entity Bean migration completed.
                
                **Migration Summary:**
                - Beans processed: ${node_count}
                
                **Review Checklist:**
                1. All CMP entities converted to JPA entities
                2. Spring Data repositories created for each entity
                3. JPA relationships properly configured (@OneToMany, @ManyToOne, etc.)
                4. All entity classes compile successfully
                5. No javax.* imports remaining (all using jakarta.*)
                6. Primary keys properly annotated with @Id and @GeneratedValue
                7. Table names specified with @Table annotation
                8. Relationships have proper cascade and fetch types
                9. Bidirectional relationships configured correctly
                10. Repository methods use JdbcTemplate, not JPA auto-generation
                
                **Next Steps:**
                - Review the migrated entities and relationships
                - Test repository methods with actual database
                - Verify relationship loading and cascading
                - Check database schema generation/validation
                
                Please verify and confirm to proceed.
              required: true
              timeout-seconds: 1800
