# Phase: BMP Entity Bean Migration
# Migrates Bean Managed Persistence entity beans to JPA entities with custom repository methods

migration-plan:
  phases:
    - id: "phase-bmp-entities"
      name: "BMP Entity Bean Migration"
      description: "Migrate Bean Managed Persistence (BMP) entity beans to JPA entities with custom repository implementations"
      
      tasks:
        - id: "task-bmp-migration"
          name: "Migrate BMP Entities to JPA"
          description: "Convert BMP entity beans to JPA entities, preserving custom SQL in repository methods"
          
          blocks:
            # Step 1: GRAPH_QUERY - Find all BMP entity beans
            - type: "GRAPH_QUERY"
              name: "query-bmp-entities"
              description: "Query all Bean Managed Persistence entity beans"
              query-type: "BY_TAGS"
              tags:
                - "ejb.bmp.entity_bean"
              output-variable: "bmp_entities"
            
            # Step 2: OPENREWRITE - Apply automated refactorings
            - type: "OPENREWRITE"
              name: "refactor-bmp-annotations"
              description: "Remove EJB-specific annotations and prepare for JPA"
              recipe: "com.analyzer.ejb2spring.MigrateBMPEntity"
              file-pattern: "**/*.java"
              base-directory: "${refactoring_project_path}/src/main/java"
            
            # Step 3: AI_ASSISTED_BATCH - Process each BMP entity
            - type: "AI_ASSISTED_BATCH"
              name: "ai-migrate-bmp-entities"
              description: "AI-assisted migration for each BMP entity bean"
              input-nodes: bmp_entities
              prompt: |
                You are migrating a Bean Managed Persistence (BMP) EJB entity bean to a modern JPA entity with custom repository implementation.
                
                **CRITICAL - TARGET DIRECTORY:**
                **YOU MUST WRITE ALL FILES TO: ${refactoring_project_path}/src/main/java**
                **DO NOT write to the source project paths listed below - those are READ-ONLY references!**
                
                **Current Node Information:**
                - Node ID: ${current_node_id}
                - Class Name: ${current_node.simpleName}
                - Fully Qualified Name: ${current_node.fullyQualifiedName}
                - Package: ${current_node.packageName}
                - Node Type: ${current_node.nodeType}
                
                **Node Tags:**
                <#list current_node.tags as tag>
                - ${tag}
                </#list>
                
                **Node Properties:**
                <#list current_node.properties?keys as key>
                - ${key}: ${current_node.getPropertyToString(key)}
                </#list>
                
                **READ-ONLY Source Reference (for reading original code only):**
                <#assign primarySource = current_node.sourceAliasPaths?filter(path -> path?ends_with(".java") && !path?contains("/.analysis/"))?first!"">
                <#if primarySource?has_content>
                - Source to read: ${primarySource}
                </#if>
                
                **WRITE Target (where you MUST write the migrated files):**
                - Target directory: ${refactoring_project_path}/src/main/java
                - Entity file: ${refactoring_project_path}/src/main/java/${current_node.packageName?replace(".", "/")}/entity/${current_node.simpleName?replace("Bean", "")}.java
                - Repository interface: ${refactoring_project_path}/src/main/java/${current_node.packageName?replace(".", "/")}/repository/${current_node.simpleName?replace("Bean", "")}Repository.java
                - Repository impl: ${refactoring_project_path}/src/main/java/${current_node.packageName?replace(".", "/")}/repository/${current_node.simpleName?replace("Bean", "")}RepositoryImpl.java
                
                ---
                
                <#-- Context-aware instructions based on node properties -->
                <#if current_node.hasProperty("bmp.sql.queries")>
                <#assign sqlQueries = current_node.getProperty("bmp.sql.queries")>
                
                **üíæ CUSTOM SQL DETECTED:**
                This BMP entity has ${sqlQueries?size} custom SQL queries that must be preserved:
                <#list sqlQueries as query>
                - ${query.methodName}: ${query.queryType}
                </#list>
                
                **SQL Preservation Instructions:**
                - Extract ALL SQL from ejbLoad, ejbStore, ejbFindXXX methods
                - Preserve exact SQL logic in custom repository implementation
                - Use Spring JdbcTemplate for JDBC operations
                - Do NOT use JPA/Hibernate query generation
                </#if>
                
                <#if current_node.hasProperty("ejb.primary_key.composite")>
                
                **‚ö†Ô∏è COMPOSITE PRIMARY KEY DETECTED:**
                - This entity uses a composite primary key
                - You'll need to create an @Embeddable key class or use @IdClass
                - Ensure proper equals() and hashCode() implementation
                </#if>
                
                <#if current_node.hasProperty("resource.analysis_result")>
                <#assign resourceAnalysis = current_node.getProperty("resource.analysis_result")>
                <#if (resourceAnalysis.dataSourceCount > 0)>
                
                **üìä DATASOURCE USAGE DETECTED:**
                - DataSources: ${resourceAnalysis.dataSourceCount}
                
                **DataSource Migration:**
                - Replace @Resource DataSource with constructor-injected Spring DataSource
                - Spring Boot auto-configures DataSource from application.properties
                </#if>
                </#if>
                
                **Migration Tasks:**
                
                1. **Convert BMP Entity to JPA Entity:**
                   - Add @Entity (jakarta.persistence) annotation
                   - Add @Table annotation with table name from ejbCreate/SQL
                   - Convert CMP fields to JPA fields with @Column annotations
                   - Add @Id and @GeneratedValue for primary key (or @EmbeddedId for composite)
                   - Remove ALL EJB lifecycle methods (ejbCreate, ejbPostCreate, ejbActivate, ejbPassivate)
                   - Remove EntityBean interface implementation
                   - Remove EntityContext field
                
                2. **Extract and Preserve SQL Logic:**
                   - Extract ALL SQL statements from ejbLoad method (SELECT)
                   - Extract ALL SQL statements from ejbStore method (UPDATE/INSERT)
                   - Extract ALL SQL statements from ejbRemove method (DELETE)
                   - Extract ALL SQL from ejbFindByXXX methods
                   - Document each SQL query with comments
                   - Note: We are NOT using JPA/Hibernate - preserve raw SQL!
                
                3. **Create Custom Repository Implementation:**
                   - Create repository interface extending JpaRepository<EntityName, PrimaryKeyType>
                   - Create custom repository implementation class with @Repository
                   - Inject JdbcTemplate via constructor
                   - Convert ejbLoad SQL to custom findById using JdbcTemplate.queryForObject()
                   - Convert ejbStore SQL to custom save using JdbcTemplate.update()
                   - Convert ejbFindByXXX methods to custom query methods using JdbcTemplate.query()
                   - Use RowMapper for result set mapping
                   - Add @Transactional to write operations
                
                4. **Handle JDBC Code Migration:**
                   - Replace Connection/PreparedStatement with JdbcTemplate
                   - Convert ResultSet mapping to RowMapper<Entity>
                   - Remove manual connection management (try-finally blocks)
                   - Remove manual transaction management
                   - Use JdbcTemplate.update() for INSERT/UPDATE/DELETE
                   - Use JdbcTemplate.query() for SELECT
                   - Use KeyHolder for auto-generated IDs if needed
                
                5. **Preserve Business Logic:**
                   - Keep all validation logic from ejbCreate
                   - Preserve error handling patterns
                   - Maintain transaction boundaries with @Transactional
                   - Keep any business rules enforced in BMP methods
                
                6. **Migration Guidelines:**
                   - Use Jakarta namespace (jakarta.persistence.*) not javax
                   - For complex SQL, keep it in custom repository methods
                   - Do NOT rely on JPA auto-generation - we use explicit SQL
                   - Use Spring JdbcTemplate or NamedParameterJdbcTemplate
                   - Document SQL queries clearly in repository methods
                   - Test thoroughly as SQL is now explicit in repository
                
                **Expected Output:**
                - JPA entity class with proper annotations (no SQL in entity)
                - Spring Data repository interface
                - Custom repository implementation class with ALL SQL preserved
                - RowMapper implementations for result set mapping
                - Updated service classes that use the repository
                - NO JPA/Hibernate query generation used
                
                Please migrate this BMP entity bean following these guidelines, preserving ALL SQL logic in the custom repository.
              working-directory: "${refactoring_project_path}/src/main/java"
              progress-message: "Migrating BMP entity"
              timeout-seconds: 600
            
            # Step 4: AI_ASSISTED - Compile and validate
            - type: "AI_ASSISTED"
              name: "compile-bmp-entities"
              description: "Compile all migrated BMP entities"
              prompt: |
                All BMP entities have been migrated to JPA entities with custom repositories.
                
                **CRITICAL - WORKING DIRECTORY:**
                **You are working in the REFACTORING PROJECT at: ${refactoring_project_path}**
                **Run all Maven commands in: ${refactoring_project_path}**
                **DO NOT run commands in the source project!**
                
                **Summary:**
                - Total beans processed: ${node_count}
                
                **Class IDs:**
                <#list bmp_entities as bean>
                - ${bean}
                </#list>
                
                **Classes:**
                <#list bmp_entities_names as className>
                - ${className}
                </#list>
                
                **Tasks:**
                1. Run Maven compile in ${refactoring_project_path} to check for errors
                2. Verify all SQL logic has been preserved in repository methods
                3. Check that JdbcTemplate is properly injected in repositories
                4. Ensure all custom repository implementations are wired correctly
                5. Verify @Repository annotations are present
                6. Check @Transactional on write operations
                7. Resolve any dependency injection issues
                8. Ensure NO JPA/Hibernate auto-queries are being used
                9. All files should be in ${refactoring_project_path}/src/main/java
                
                Please compile the classes in ${refactoring_project_path} and fix any errors.
              working-directory: "${refactoring_project_path}"
              timeout-seconds: 300
            
            # Step 5: INTERACTIVE_VALIDATION
            - type: "INTERACTIVE_VALIDATION"
              name: "verify-bmp-migration"
              validation-type: "MANUAL_CONFIRM"
              message: |
                BMP Entity Bean migration completed.
                
                **Migration Summary:**
                - Beans processed: ${node_count}
                
                **Review Checklist:**
                1. All BMP entities converted to JPA entities
                2. Custom SQL preserved in repository methods using JdbcTemplate
                3. Repository interfaces and implementations created
                4. All entity classes compile successfully
                5. No javax.* imports remaining (all using jakarta.*)
                6. JdbcTemplate properly configured and injected
                7. Transaction management properly configured with @Transactional
                8. RowMappers implemented for result set mapping
                9. NO JPA/Hibernate query auto-generation used
                
                **Next Steps:**
                - Review custom SQL implementations in repositories
                - Test repository methods with actual database
                - Verify transaction boundaries
                - Compare query results with original BMP implementation
                
                Please verify and confirm to proceed.
              required: true
              timeout-seconds: 1800
