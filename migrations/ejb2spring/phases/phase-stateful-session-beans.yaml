# Phase: Stateful Session Bean Migration
# Migrates stateful session beans to Spring session-scoped components

migration-plan:
  phases:
    - id: "phase-stateful-session"
      name: "Stateful Session Bean Migration"
      description: "Migrate stateful session beans to Spring session-scoped components"
      
      tasks:
        - id: "task-stateful-migration"
          name: "Migrate Stateful Session Beans"
          description: "Convert stateful session beans to Spring session-scoped beans"
          
          blocks:
            # Step 1: GRAPH_QUERY - Find all stateful session beans
            - type: "GRAPH_QUERY"
              name: "query-stateful-beans"
              description: "Query all stateful session beans"
              query-type: "BY_TAGS"
              tags:
                - "ejb.stateful.session_bean"
              output-variable: "stateful_beans"
            
            # Step 2: OPENREWRITE - Apply automated refactorings
            - type: "OPENREWRITE"
              name: "refactor-stateful-annotations"
              description: "Replace @Stateful with @Component and @Scope"
              recipe: "com.analyzer.ejb2spring.MigrateStatefulSession"
              file-pattern: "**/*.java"
              base-directory: "${project_root}/${artifact_id}/src/main/java"
            
            # Step 3: AI_ASSISTED_BATCH - Process each stateful session bean
            - type: "AI_ASSISTED_BATCH"
              name: "ai-migrate-stateful-beans"
              description: "AI-assisted migration for each stateful session bean"
              input-nodes: stateful_beans
              prompt: |
                You are migrating a Stateful Session Bean to a Spring session-scoped component.
                
                **Current Node Information:**
                - Node ID: ${current_node_id}
                - Class Name: ${current_node.simpleName}
                - Fully Qualified Name: ${current_node.fullyQualifiedName}
                - Package: ${current_node.packageName}
                - Node Type: ${current_node.nodeType}
                
                **Node Tags:**
                <#list current_node.tags as tag>
                - ${tag}
                </#list>
                
                **Node Properties:**
                <#list current_node.properties?keys as key>
                - ${key}: ${current_node.getPropertyToString(key)}
                </#list>
                
                **Source Locations:**
                <#list current_node.sourceAliasPaths?filter(path -> path?ends_with(".java")) as sourcePath>
                - ${sourcePath}
                </#list>
                
                ---
                
                <#-- Context-aware instructions based on node properties -->
                <#if current_node.hasProperty("ejb.conversational.state.fields")>
                <#assign stateFields = current_node.getProperty("ejb.conversational.state.fields")>
                <#if (stateFields?size > 0)>
                
                **‚ö†Ô∏è CONVERSATIONAL STATE DETECTED:**
                This stateful bean has ${stateFields?size} conversational state fields:
                <#list stateFields as field>
                - ${field.name} (${field.type})
                </#list>
                
                **State Management Instructions:**
                - These fields must remain in session scope
                - Ensure all state fields are Serializable
                - Consider using HttpSession attributes for complex state
                - Implement proper cleanup in @PreDestroy
                </#if>
                </#if>
                
                <#if current_node.hasProperty("ejb.session_bean.migrationComplexity")>
                
                **Migration Complexity: ${current_node.getStringProperty("ejb.session_bean.migrationComplexity", "UNKNOWN")}**
                </#if>
                
                <#if current_node.hasProperty("resource.analysis_result")>
                <#assign resourceAnalysis = current_node.getProperty("resource.analysis_result")>
                <#if (resourceAnalysis.dataSourceCount > 0 || resourceAnalysis.resourceRefCount > 0)>
                
                **üìä RESOURCE USAGE DETECTED:**
                - DataSources: ${resourceAnalysis.dataSourceCount}
                - Resource References: ${resourceAnalysis.resourceRefCount}
                
                **Resource Migration Instructions:**
                - Replace @Resource DataSource with constructor-injected Spring DataSource
                - Use application.properties for datasource configuration
                - Spring Boot will auto-configure connection pool
                </#if>
                </#if>
                
                **Migration Tasks:**
                
                1. **Convert to Spring Session-Scoped Component:**
                   - Replace @Stateful with @Component
                   - Add @Scope(value = WebApplicationContext.SCOPE_SESSION, proxyMode = ScopedProxyMode.TARGET_CLASS)
                   - Or use @SessionScope annotation for simpler cases
                   - Implement Serializable if storing in HTTP session
                   - Remove @Local and @Remote interface annotations
                
                2. **Handle Conversational State:**
                   - Identify stateful fields that maintain conversation state
                   - Ensure these fields are Serializable (especially collections)
                   - Consider using @PreDestroy for cleanup before session invalidation
                   - Replace @Remove methods with explicit cleanup logic or session invalidation
                
                3. **Update Passivation/Activation:**
                   - Remove @PrePassivate and @PostActivate (EJB-specific)
                   - Use @PreDestroy for cleanup before session invalidation
                   - Consider using HttpSessionListener for session lifecycle events
                   - Document serialization requirements for session attributes
                
                4. **Dependency Injection:**
                   - Convert @EJB to constructor injection with @Autowired
                   - Use constructor-based dependency injection (preferred in Spring)
                   - Be careful with injecting singletons into session-scoped beans (use proxies)
                   - Remove any @Resource injections and replace with Spring equivalents
                
                5. **Transaction Management:**
                   - Add @Transactional to methods that need transactions
                   - Use @Transactional(readOnly = true) for read-only operations
                   - Remove @TransactionAttribute and use Spring's @Transactional properties
                
                6. **Migration Guidelines:**
                   - Use Jakarta namespace (jakarta.* not javax.*)
                   - Document stateful behavior clearly in class JavaDoc
                   - Consider if stateful bean is truly necessary (can it be stateless with request params?)
                   - Use session attributes for simple state
                   - Implement proper session timeout handling
                   - Test serialization/deserialization of session state
                   - Prefer constructor injection over field injection
                   - Make injected fields final when possible
                
                **Expected Output:**
                - Spring session-scoped component with @SessionScope
                - Proper state management with Serializable implementation
                - Constructor-based dependency injection
                - Clear documentation of stateful behavior
                - Cleanup methods implemented (@PreDestroy)
                
                Please migrate this stateful session bean to a Spring session-scoped component.
              working-directory: "${project_root}/${artifact_id}/src/main/java"
              progress-message: "Migrating stateful session bean"
              timeout-seconds: 600
            
            # Step 4: AI_ASSISTED - Compile and validate
            - type: "AI_ASSISTED"
              name: "compile-stateful-components"
              description: "Compile all migrated stateful components"
              prompt: |
                All stateful session beans have been migrated to Spring session-scoped components.
                
                **Summary:**
                - Total beans processed: ${node_count}
                
                **Class IDs:**
                <#list stateful_beans as bean>
                - ${bean}
                </#list>
                
                **Classes:**
                <#list stateful_beans_names as className>
                - ${className}
                </#list>
                
                **Tasks:**
                1. Run Maven compile to check for errors
                2. Verify all @SessionScope annotations are correctly placed
                3. Check Serializable implementation for classes with state
                4. Verify constructor injection is working properly
                5. Test session management and lifecycle
                6. Ensure no EJB imports remaining
                7. Fix any circular dependency issues
                
                Please compile ONLY the classes that were migrated, and fix any errors.
              working-directory: "${project_root}"
              timeout-seconds: 300
            
            # Step 5: INTERACTIVE_VALIDATION
            - type: "INTERACTIVE_VALIDATION"
              name: "verify-stateful-migration"
              validation-type: "MANUAL_CONFIRM"
              message: |
                Stateful Session Bean migration completed.
                
                **Migration Summary:**
                - Beans processed: ${node_count}
                
                **Review Checklist:**
                1. All @Stateful replaced with @SessionScope or @Scope
                2. Session-scoped components properly configured
                3. State properly serializable
                4. Constructor injection used for dependencies
                5. Cleanup methods implemented (@PreDestroy)
                6. No EJB imports remaining
                7. All services compile successfully
                8. Session management tested
                
                Please verify and confirm to proceed.
              required: true
              timeout-seconds: 1800
