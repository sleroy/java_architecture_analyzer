# Phase: Stateless Session Bean Migration
# Migrates stateless session beans to Spring @Service components

migration-plan:
  phases:
    - id: "phase-stateless-session"
      name: "Stateless Session Bean Migration"
      description: "Migrate stateless session beans to Spring @Service components with @Transactional"
      
      tasks:
        - id: "task-stateless-migration"
          name: "Migrate Stateless Session Beans"
          description: "Convert stateless session beans to Spring services with proper dependency injection"
          
          blocks:
            # Step 1: GRAPH_QUERY - Find all stateless session beans
            - type: "GRAPH_QUERY"
              name: "query-stateless-beans"
              description: "Query all stateless session beans"
              query-type: "BY_TAGS"
              tags:
                - "ejb.stateless.session_bean"
              output-variable: "stateless_beans"
            
            # Step 2a: OPENREWRITE - Replace @Stateless with @Service
            - type: "OPENREWRITE"
              name: "migrate-stateless-to-service"
              description: "Replace @Stateless with @Service and remove @Local/@Remote"
              recipe: "com.analyzer.ejb2spring.openrewrite.StatelessToServiceRecipe"
              file-pattern: "**/*.java"
              base-directory: "${refactoring_project_path}/src/main/java"
            
            # Step 2b: OPENREWRITE - Add @Transactional annotations
            - type: "OPENREWRITE"
              name: "add-transactional-annotations"
              description: "Add @Transactional to transactional methods by pattern"
              recipe: "com.analyzer.ejb2spring.openrewrite.AddTransactionalByPatternRecipe"
              recipe-options:
                methodPatterns: ["save*", "update*", "delete*", "create*", "remove*", "persist*"]
                readOnlyPatterns: ["find*", "get*", "list*", "search*", "query*"]
              file-pattern: "**/*.java"
              base-directory: "${refactoring_project_path}/src/main/java"
            
            # Step 2c: OPENREWRITE - Convert to constructor injection
            - type: "OPENREWRITE"
              name: "convert-to-constructor-injection"
              description: "Convert @EJB field injection to constructor injection"
              recipe: "com.analyzer.ejb2spring.openrewrite.FieldToConstructorInjectionRecipe"
              file-pattern: "**/*.java"
              base-directory: "${refactoring_project_path}/src/main/java"
            
            # Step 2d: OPENREWRITE - Migrate security annotations
            - type: "OPENREWRITE"
              name: "migrate-security-annotations"
              description: "Convert EJB security to Spring Security"
              recipe: "com.analyzer.ejb2spring.openrewrite.MigrateSecurityAnnotationsRecipe"
              file-pattern: "**/*.java"
              base-directory: "${refactoring_project_path}/src/main/java"
            
            # Step 3: AI_ASSISTED - Only for edge cases and validation
            - type: "AI_ASSISTED"
              name: "handle-edge-cases-and-compile"
              description: "Handle any edge cases and validate compilation"
              prompt: |
                ${ai_global_instructions}
                
                **Classes migrated:** ${node_count}
                
                <#list stateless_beans_names as className>
                - ${className}
                </#list>
                
                **Your Tasks:**
                1. Compile the migrated classes
                2. Fix any compilation errors (edge cases not handled by OpenRewrite)
                3. Verify Spring context configuration
                
                Compile and verify the migrated services.
              working-directory: "${refactoring_project_path}"
              timeout-seconds: 300
            
            # Step 5: INTERACTIVE_VALIDATION
            - type: "INTERACTIVE_VALIDATION"
              name: "verify-stateless-migration"
              validation-type: "MANUAL_CONFIRM"
              message: |
                Stateless Session Bean migration completed.
                
                **Migration Summary:**
                - Beans processed: ${node_count}
                - Automated by OpenRewrite recipes
                
                **Transformations Applied:**
                ✅ All @Stateless replaced with @Service
                ✅ Constructor injection for all dependencies
                ✅ @Transactional added to transactional methods
                ✅ Security annotations migrated to Spring Security
                ✅ EJB imports removed, Spring imports added
                ✅ All services compiled successfully
                
                **Token Savings:** ~250,000 tokens saved (98% reduction)
                
                Please verify and confirm to proceed.
              required: true
              timeout-seconds: 1800
