# Phase 1: Spring Boot Project Initialization
# Extracted from JBoss EJB 2 to Spring Boot Migration Plan

migration-plan:
  phases:
    - id: "phase-1"
      name: "Spring Boot Project Initialization"
      description: "Bootstrap Spring Boot application structure"

      tasks:
        - id: "task-100"
          name: "Create Spring Boot Parent POM"
          description: "Initialize Spring Boot project with proper parent and dependency management"

          blocks:
            - type: "COMMAND"
              name: "detect-jdk-version"
              description: "Detect installed JDK major version and store in context"
              command: |
                # Detect JDK version and store for use by next commands
                # Use sed instead of grep -oP for better portability
                DETECTED_VERSION=$(java -version 2>&1 | head -1 | sed -n 's/.*version "\([0-9]*\).*/\1/p')
                echo "$DETECTED_VERSION"
              working-directory: "${project_root}"
              timeout-seconds: 10
              output-variable: "detected_java_version"

            - type: "COMMAND"
              name: "generate-springboot-project"
              description: "Generate Spring Boot project using Spring Initializr with detected JDK version"
              command: |
                # Use detected Java version from previous block
                # Trim whitespace from detected version
                DETECTED_JAVA=$(echo "${detected_java_version}" | tr -d '[:space:]')
                echo "Using detected Java version: $DETECTED_JAVA"
                curl 'https://start.spring.io/starter.zip?type=maven-project&language=java&bootVersion=${spring_boot_version}&baseDir=${artifact_id}&groupId=${group_id}&artifactId=${artifact_id}&name=Unicorn+Spring+Boot+Application&description=Unicorn+application+migrated+from+JBoss+EJB+2+to+Spring+Boot&packageName=${group_id}.springboot&packaging=jar&javaVersion=21&dependencies=web,data-jpa,validation,actuator,devtools,configuration-processor,h2,mail,security,data-jdbc,jdbc,web-services' -o springboot-baseline.zip
              working-directory: "${project_root}"
              timeout-seconds: 60

            - type: "COMMAND"
              name: "extract-springboot-project"
              description: "Extract generated Spring Boot project"
              command: |
                unzip -o springboot-baseline.zip
                rm springboot-baseline.zip
              working-directory: "${project_root}"
              timeout-seconds: 30

            - type: "AI_ASSISTED"
              name: "optimize-springboot-pom"
              working-directory: "${project_root}/${artifact_id}"
              description: "Optimize Spring Boot POM based on EJB dependency analysis"
              prompt: |
                You are tasked with optimizing the Spring Boot ${spring_boot_version} POM file based on the analysis of the JBoss EJB 2 application.

                ## Your Task

                1. **Read the current POM file** at: ${project_root}/${artifact_id}/pom.xml
                   (This was generated by Spring Initializr with baseline dependencies)

                2. **Read the dependency mapping analysis** at: ${project_root}/docs/DEPENDENCY_MAPPING.md
                   (This contains the mapping from EJB dependencies to Spring Boot equivalents)

                3. **Update the POM file directly** with the following optimizations:

                   **Base Configuration Updates**:
                   - Change version to: 1.0.0-SNAPSHOT
                   - Add explicit packaging: jar
                   - Clean up empty metadata sections (licenses, developers, scm)

                   **Build Configuration**:
                   - Ensure maven-compiler-plugin is configured with source/target ${detected_java_version}
                   - Keep spring-boot-maven-plugin with proper configuration

                   **Profiles** (add these for environment-specific configuration):
                   - dev profile: active by default, uses H2 database for development
                   - prod profile: uses MySQL driver for production

                ## Critical Requirements

                - **DO NOT output the POM content** - edit the file directly using your file editing tools
                - The POM MUST be valid XML and pass `mvn validate`
                - Preserve all Maven property references (e.g., $\{springdoc.version\})
                - Ensure Spring Boot ${spring_boot_version} remains as parent
                - Use detected Java version from system (auto-detected in previous block)
                - All dependencies must have valid coordinates
                - **Read the POM file** at: ${project_root}/${artifact_id}/pom.xml
                - **Run validation** to see specific errors: `mvn validate`
                - **Attempt compilation** to see compile errors: `mvn clean compile`
                - **Analyze errors** from Maven output
                - **Fix the POM** directly


                **System Information**:
                - Detected JDK Version: ${detected_java_version}
                - Spring Boot Version: ${spring_boot_version}
                - Java Version: ${detected_java_version}
                - JAVA_HOME: ${maven_java_home}
                  
                
              timeout-seconds: 360

            - type: "MAVEN"
              name: "validate-pom"
              description: "Test that Spring Boot application starts successfully in ${project_root}/${artifact_id}"
              goals: "validate"
              java-home: "${maven_java_home}"
              maven-home: "${maven_home}"
              working-directory: "${project_root}/${artifact_id}"
              timeout-seconds: 30

            - type: "INTERACTIVE_VALIDATION"
              name: "verify-pom-creation"
              description: "Verify Spring Boot POM creation"
              validation-type: "MANUAL_CONFIRM"
              message: |
                Spring Boot project initialized successfully using Spring Initializr + AI optimization.

                - Base project generated with Spring Initializr
                - POM optimized with AI analysis based on EJB components
                - Spring Boot ${spring_boot_version} parent configured
                - Java ${java_version} configured
                - Maven validation successful
                - Compilation successful

                Review the optimized POM and confirm:
                1. Spring Boot version is correct
                2. Java version matches environment
                3. Dependencies include EJB-specific mappings
                4. All dependencies resolve without errors
                5. Build configuration is appropriate
                6. AI optimization comments are helpful

                Proceed to create main application class?
              required: true
              timeout-seconds: 1800

        - id: "task-101"
          name: "Create Spring Boot Main Application Class"
          description: "Create the entry point for Spring Boot application"

          blocks:
            - type: "FILE_OPERATION"
              name: "create-main-application-class"
              description: "Create UnicornApplication.java main class"
              operation: "CREATE"
              path: "${project_root}/${artifact_id}/src/main/java/${package_base}/UnicornApplication.java"
              content: |
                package ${package_base};

                import org.springframework.boot.SpringApplication;
                import org.springframework.boot.autoconfigure.SpringBootApplication;

                @SpringBootApplication
                public class UnicornApplication {
                    public static void main(String[] args) {
                        SpringApplication.run(UnicornApplication.class, args);
                    }
                }

            - type: "FILE_OPERATION"
              name: "create-application-properties"
              description: "Create application.properties configuration file"
              operation: "CREATE"
              path: "${project_root}/${artifact_id}/src/main/resources/application.properties"
              content: |
                # Application Configuration
                spring.application.name=${artifact_id}
                server.port=8080

                # Logging Configuration
                logging.level.com.example.ejbapp=DEBUG
                logging.level.org.springframework=INFO

        - id: "task-102"
          name: "Copy Original Java Source Code"
          description: "Copy all Java source files from ALL Maven subprojects to Spring Boot project"

          blocks:
            - type: "COMMAND"
              name: "copy-java-sources-from-all-modules"
              description: "Copy Java sources from all Maven modules preserving package structure"
              command: |
                # Ensure target directory exists
                mkdir -p ${artifact_id}/src/main/java

                echo "========================================="
                echo "Copying Java sources from all Maven modules"
                echo "Target: ${artifact_id}/src/main/java"
                echo "========================================="

                # Find all src/main/java directories in Maven modules
                # Exclude: target directories, and the Spring Boot project itself
                for java_src in $(find . -type d -path "*/src/main/java" \
                                  ! -path "*/target/*" \
                                  ! -path "*/${artifact_id}/*"); do

                  if [ -d "$java_src" ] && [ "$(ls -A $java_src 2>/dev/null)" ]; then
                    echo "Copying from: $java_src"
                    # Copy all contents, preserving structure, NO filtering
                    cp -r "$java_src"/* ${artifact_id}/src/main/java/
                  fi
                done

                # Count total Java files copied
                TOTAL_FILES=$(find ${artifact_id}/src/main/java -name "*.java" -type f | wc -l)
                echo "========================================="
                echo "✓ Total Java files in target: $TOTAL_FILES"
                echo "✓ Location: ${project_root}/${artifact_id}/src/main/java/"
                echo "========================================="
              working-directory: "${project_root}"
              timeout-seconds: 120

            - type: "INTERACTIVE_VALIDATION"
              name: "verify-source-copy"
              description: "Verify Java source files were copied from all modules"
              validation-type: "MANUAL_CONFIRM"
              message: |
                All Java source code from ALL Maven subprojects has been copied to Spring Boot project.

                Source: All */src/main/java directories in the project
                Target: ${project_root}/${artifact_id}/src/main/java/

                ⚠️ IMPORTANT: The project will NOT compile at this stage - this is EXPECTED!

                The copied code includes:
                - All Java files from all Maven modules
                - Original package structure preserved
                - No filtering or modifications applied
                - EJB annotations, imports, and dependencies still present

                Verify:
                1. Check ${artifact_id}/src/main/java/ contains Java files
                2. Package directories are intact (e.g., com/company/...)
                3. File count matches expectation from all modules
                4. No compilation was attempted (files only)

                Next phases will handle:
                - Phase 1b: Refactoring Setup (Git branching, documentation)
                - Phase 2+: EJB to Spring refactoring
                - Resolving compilation errors
                - Updating imports and annotations

                Phase 1 initialization complete. Proceed to Phase 1b?
              required: true
              timeout-seconds: 1800
