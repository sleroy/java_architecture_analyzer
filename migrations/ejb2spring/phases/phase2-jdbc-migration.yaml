# Phase 2: Database Connectivity Migration (JDBC)
# JBoss DataSource to Spring JDBC
# Tasks: 200-203

migration-plan:
  phases:
    - id: "phase-2"
      name: "Database Connectivity Migration (JDBC)"
      description: "Migrate JBoss DataSource to Spring JDBC with HikariCP"
      
      tasks:
        - id: "task-200"
          name: "Identify Database Configuration"
          description: "Locate and document all database connectivity configuration in the JBoss application"
          pattern-tag: "DATASOURCE_CONFIG_IDENTIFICATION"
          
          blocks:
            - type: "COMMAND"
              name: "find-datasource-xml-files"
              description: "Find all JBoss datasource configuration files"
              command: |
                find ${project_root} -name "*-ds.xml" -o -name "standalone.xml" -o -name "domain.xml" 2>/dev/null || true
              working-directory: "${project_root}"
              timeout-seconds: 60
              capture-output: true
              output-variable: "datasource_config_files"
              
            - type: "GRAPH_QUERY"
              name: "query-jndi-lookups"
              description: "Query graph for JNDI lookup patterns (tagged by JndiLookupInspector)"
              query-type: "BY_TAGS"
              tags:
                - "jndi_lookup_inspector.uses_jndi"
              output-variable: "jndi_lookup_nodes"
              
            - type: "AI_PROMPT"
              name: "analyze-datasource-configuration"
              description: "AI analysis of datasource configurations"
              prompt: |
                Analyze the JBoss datasource configuration for Spring Boot migration.
                
                ## DataSource Configuration Files Found:
                ${datasource_config_files}
                
                ## JNDI Lookups Found (from graph analysis):
                Count: ${jndi_lookup_nodes.size()}
                <#list jndi_lookup_nodes as node>
                - **Class:** ${node.fullyQualifiedName}
                  - **JNDI Names:** ${node.properties.jndi_lookup_analysis.jndiNames}
                  - **DataSource References:** ${node.properties.jndi_lookup_analysis.dataSourceReferences}
                  - **Complexity:** ${node.properties.jndi_lookup_inspector.complexity}
                </#list>
                
                Please provide:
                1. **DataSource Inventory**: List all datasources with JNDI names
                2. **Connection Parameters**: Extract URL, driver, username patterns
                3. **Pool Settings**: Document min/max pool sizes, timeouts
                4. **Transaction Settings**: XA vs non-XA datasources
                5. **Migration Mapping**: Map each JNDI name to Spring configuration property prefix
                
                Format as a structured analysis for documentation.
              output-variable: "datasource_analysis"
              temperature: 0.2
              max-tokens: 2000
              
            - type: "FILE_OPERATION"
              name: "create-datasource-inventory"
              description: "Create DATASOURCE_INVENTORY.md documentation"
              operation: "CREATE"
              path: "${project_root}/docs/migration/DATASOURCE_INVENTORY.md"
              content: |
                # DataSource Configuration Inventory
                
                **Generated:** ${current_datetime}
                **Migration Phase:** Phase 2 - JDBC Migration
                **Pattern TAG:** DATASOURCE_CONFIG_IDENTIFICATION
                
                ## Overview
                
                This document catalogs all JBoss datasource configurations discovered in the application.
                
                ## DataSource Configuration Files
                
                ${datasource_config_files}
                
                ## JNDI Lookup Locations (from graph analysis)
                
                Total classes with JNDI lookups: ${jndi_lookup_nodes.size()}
                
                <#list jndi_lookup_nodes as node>
                ### ${node.fullyQualifiedName}
                - File: ${node.sourceFilePath}
                - JNDI Names: ${node.properties.jndi_lookup_analysis.jndiNames}
                - DataSource References: ${node.properties.jndi_lookup_analysis.dataSourceReferences}
                - Migration Complexity: ${node.properties.jndi_lookup_inspector.complexity}
                </#list>
                
                ## AI Analysis
                
                ${datasource_analysis}
                
                ## Spring Boot Migration Strategy
                
                Each JBoss JNDI datasource will be migrated to Spring Boot configuration:
                
                ```properties
                # JBoss: java:jboss/datasources/MyAppDS
                # Spring: spring.datasource.*
                
                spring.datasource.url=jdbc:...
                spring.datasource.username=...
                spring.datasource.password=...
                spring.datasource.hikari.maximum-pool-size=50
                ```
                
                ## Next Steps
                
                Proceed to TASK-201: Configure Spring JDBC DataSource
                
            - type: "INTERACTIVE_VALIDATION"
              name: "verify-datasource-inventory"
              description: "Review datasource inventory"
              validation-type: "MANUAL_CONFIRM"
              message: |
                DataSource inventory completed.
                
                - Configuration files identified
                - JNDI lookups documented
                - @Resource injections catalogued
                - AI analysis generated
                - DATASOURCE_INVENTORY.md created
                
                Please review the inventory and confirm:
                1. All datasources are documented
                2. Connection parameters are captured
                3. No critical datasources missing
                
                Proceed to configure Spring DataSource?
              required: true
              timeout-seconds: 1800
              
        - id: "task-201"
          name: "Configure Spring JDBC DataSource"
          description: "Replace JBoss datasource with Spring Boot HikariCP datasource"
          pattern-tag: "DATASOURCE_CONFIG_SPRING"
          
          blocks:
            - type: "AI_PROMPT"
              name: "generate-spring-datasource-config"
              description: "Generate Spring Boot datasource configuration"
              prompt: |
                Based on the datasource inventory analysis:
                
                ${datasource_analysis}
                
                Generate Spring Boot application.properties configuration for HikariCP datasource.
                
                Requirements:
                1. Use environment variables for sensitive data (username, password)
                2. Match pool settings from JBoss configuration
                3. Include connection validation
                4. Configure transaction settings
                5. Add separate profiles (dev, test, prod)
                
                Provide three configuration files:
                - application.properties (base config)
                - application-dev.properties (development)
                - application-prod.properties (production)
              output-variable: "spring_datasource_config"
              temperature: 0.2
              max-tokens: 1500
              
            - type: "FILE_OPERATION"
              name: "create-application-properties"
              description: "Create application.properties with datasource config"
              operation: "CREATE"
              path: "${project_root}/semeru-springboot/src/main/resources/application.properties"
              content: |
                ${spring_datasource_config}
                
            - type: "FILE_OPERATION"
              name: "add-jdbc-dependency"
              description: "Add Spring JDBC starter to POM"
              operation: "APPEND"
              path: "${project_root}/semeru-springboot/pom.xml"
              content: |
                
                        <!-- JDBC Support (Pure JDBC - NO JPA) -->
                        <dependency>
                            <groupId>org.springframework.boot</groupId>
                            <artifactId>spring-boot-starter-jdbc</artifactId>
                        </dependency>
                        
                        <!-- Transaction Management -->
                        <dependency>
                            <groupId>org.springframework</groupId>
                            <artifactId>spring-tx</artifactId>
                        </dependency>
                        
                        <!-- Database Driver (adjust based on database) -->
                        <dependency>
                            <groupId>org.postgresql</groupId>
                            <artifactId>postgresql</artifactId>
                            <scope>runtime</scope>
                        </dependency>
                
            - type: "COMMAND"
              name: "test-datasource-connection"
              description: "Test datasource configuration"
              enable_if: "${database_enabled}"
              command: |
                cd ${project_root}/semeru-springboot && \
                mvn clean compile && \
                timeout 30 mvn spring-boot:run &
                sleep 20
                pkill -f "spring-boot:run"
                echo "DataSource test completed"
              working-directory: "${project_root}"
              timeout-seconds: 120
              capture-output: true
              
            - type: "INTERACTIVE_VALIDATION"
              name: "verify-datasource-configuration"
              description: "Verify Spring datasource setup"
              validation-type: "MANUAL_CONFIRM"
              message: |
                Spring DataSource configured successfully.
                
                - application.properties created with HikariCP config
                - JDBC dependencies added to POM
                <#if database_enabled>
                - Application startup tested
                - Connection pool initialized
                
                Verify:
                1. HikariPool appears in logs
                2. No connection errors
                3. Health endpoint shows database UP
                4. Pool settings match requirements
                <#else>
                - Database connection testing skipped (database_enabled=false)
                
                Note: Database operations are disabled. Set database_enabled=true to test connections.
                </#if>
                
                Proceed to identify JDBC wrappers?
              required: true
              timeout-seconds: 1800
              
        - id: "task-202"
          name: "Identify Custom JDBC Wrappers"
          description: "Locate all custom JDBC wrapper classes and database access patterns"
          pattern-tag: "JDBC_WRAPPER_IDENTIFICATION"
          
          blocks:
            - type: "GRAPH_QUERY"
              name: "query-jdbc-data-access-classes"
              description: "Query graph for classes with JDBC data access patterns (tagged by JdbcDataAccessPatternInspector)"
              query-type: "BY_TAGS"
              tags:
                - "dataAccess.layer"
              output-variable: "jdbc_wrapper_nodes"
              
            - type: "AI_PROMPT"
              name: "analyze-jdbc-wrappers"
              description: "Analyze JDBC wrapper patterns from JavaClassNode objects"
              prompt: |
                Analyze the custom JDBC data access classes found by the JdbcDataAccessPatternInspector.
                
                ## JDBC Data Access Classes Found:
                Total classes: ${jdbc_wrapper_nodes.size()}
                
                <#list jdbc_wrapper_nodes as node>
                ### Class: ${node.fullyQualifiedName}
                - **Package:** ${node.packageName}
                - **File:** ${node.sourceFilePath}
                - **Migration Complexity:** ${node.properties.jdbc_data_access_analysis.migrationComplexity}
                - **Has Connection Usage:** ${node.properties.jdbc_features.hasConnectionUsage}
                - **Has PreparedStatement:** ${node.properties.jdbc_features.hasPreparedStatementUsage}
                - **Has ResultSet Processing:** ${node.properties.jdbc_features.hasResultSetProcessing}
                - **Is DAO Pattern:** ${node.properties.jdbc_features.isDataAccessObject}
                - **Is JdbcTemplate Candidate:** ${node.properties.jdbc_features.isJdbcTemplateCandidate}
                
                **Spring Recommendations:**
                <#list node.properties.jdbc_data_access_analysis.springRecommendations as rec>
                - ${rec}
                </#list>
                
                **SQL Queries Found:**
                <#list node.properties.jdbc_data_access_analysis.sqlQueries as sql>
                ```sql
                ${sql}
                ```
                </#list>
                
                </#list>
                
                ## Analysis Required:
                
                Provide a migration strategy document with:
                1. **Summary**: Count of classes by complexity (LOW, MEDIUM, HIGH)
                2. **Migration Order**: Prioritize classes for migration
                3. **Common Patterns**: Identify shared JDBC patterns across classes
                4. **JdbcTemplate Mapping**: How to map each pattern to Spring JdbcTemplate
                5. **Risk Assessment**: Identify potential migration challenges
                
                Format as structured Markdown documentation.
              output-variable: "jdbc_wrapper_analysis"
              temperature: 0.2
              max-tokens: 2500
              
            - type: "FILE_OPERATION"
              name: "create-jdbc-wrapper-inventory"
              description: "Create JDBC_WRAPPER_INVENTORY.md"
              operation: "CREATE"
              path: "${project_root}/docs/migration/JDBC_WRAPPER_INVENTORY.md"
              content: |
                # JDBC Wrapper Classes Inventory
                
                **Generated:** ${current_datetime}
                **Migration Phase:** Phase 2 - JDBC Migration
                **Pattern TAG:** JDBC_WRAPPER_IDENTIFICATION
                
                ## Overview
                
                Custom JDBC data access classes detected by JdbcDataAccessPatternInspector.
                Total classes found: ${jdbc_wrapper_nodes.size()}
                
                ## AI Analysis
                
                ${jdbc_wrapper_analysis}
                
                ## Migration Strategy
                
                Each data access class will be replaced with:
                1. Spring @Repository DAO class
                2. JdbcTemplate for SQL execution
                3. Constructor injection of JdbcTemplate
                4. @Transactional for transaction management
                5. Spring exception translation (DataAccessException)
                
                ## Next Steps
                
                Proceed to TASK-203: Migrate JDBC Wrappers to Spring JdbcTemplate
                
            - type: "INTERACTIVE_VALIDATION"
              name: "verify-jdbc-wrapper-inventory"
              description: "Review JDBC wrapper inventory"
              validation-type: "MANUAL_CONFIRM"
              message: |
                JDBC wrapper inventory completed.
                
                - Wrapper classes identified
                - JDBC patterns analyzed
                - Usage locations documented
                - Migration strategy defined
                - JDBC_WRAPPER_INVENTORY.md created
                
                Review the inventory and confirm:
                1. All custom JDBC wrappers captured
                2. Usage patterns understood
                3. Migration approach is clear
                
                Proceed to migrate wrappers to JdbcTemplate?
              required: true
              timeout-seconds: 1800
              
        - id: "task-203"
          name: "Migrate JDBC Wrappers to Spring JdbcTemplate"
          description: "Replace custom JDBC wrappers with Spring JdbcTemplate while maintaining existing SQL"
          pattern-tag: "JDBC_WRAPPER_MIGRATION"
          
          blocks:
            - type: "AI_PROMPT_BATCH"
              name: "generate-jdbc-template-daos"
              description: "Generate Spring JdbcTemplate DAOs for each JDBC data access class"
              items-variable: "jdbc_wrapper_nodes"
              prompt-template: |
                Convert this JDBC data access class to a Spring JdbcTemplate DAO.
                
                ## Original Class Information:
                - **Fully Qualified Name:** ${current_item.fullyQualifiedName}
                - **Package:** ${current_item.packageName}
                - **Simple Name:** ${current_item.simpleName}
                - **Source File:** ${current_item.sourceFilePath}
                - **Migration Complexity:** ${current_item.properties.jdbc_data_access_analysis.migrationComplexity}
                
                ## JDBC Pattern Analysis:
                - **Has Connection Usage:** ${current_item.properties.jdbc_features.hasConnectionUsage}
                - **Has PreparedStatement:** ${current_item.properties.jdbc_features.hasPreparedStatementUsage}
                - **Has ResultSet Processing:** ${current_item.properties.jdbc_features.hasResultSetProcessing}
                - **Is DAO Pattern:** ${current_item.properties.jdbc_features.isDataAccessObject}
                - **JdbcTemplate Candidate:** ${current_item.properties.jdbc_features.isJdbcTemplateCandidate}
                
                ## Spring Recommendations:
                <#list current_item.properties.jdbc_data_access_analysis.springRecommendations as rec>
                - ${rec}
                </#list>
                
                ## SQL Queries to Preserve:
                <#list current_item.properties.jdbc_data_access_analysis.sqlQueries as sql>
                ```sql
                ${sql}
                ```
                </#list>
                
                ## Task:
                Generate a complete Spring @Repository DAO class that:
                1. **Class Name:** ${current_item.simpleName}Dao or ${current_item.simpleName}Repository
                2. **Package:** ${current_item.packageName}.spring (or appropriate Spring package)
                3. Uses JdbcTemplate for all SQL operations
                4. Preserves all existing SQL queries exactly as shown above
                5. Implements proper error handling with EmptyResultDataAccessException
                6. Uses Optional<T> for nullable results
                7. Implements RowMapper for result set mapping
                8. Uses @Transactional for write operations
                9. Handles batch operations if present
                10. Includes comprehensive JavaDoc comments
                
                **Provide complete, compilable Java code ready for production use.**
              output-variable: "generated_daos"
              temperature: 0.2
              max-tokens: 3000
              parallel: false
              
            - type: "FILE_OPERATION"
              name: "create-dao-classes"
              description: "Create generated DAO classes"
              operation: "CREATE_MULTIPLE"
              files: "${generated_daos}"
              base-path: "${project_root}/semeru-springboot/src/main/java/${package_base_path}/dao"
              
            - type: "OPENREWRITE"
              name: "refactor-wrapper-usage"
              description: "Replace wrapper usage with DAO injection"
              recipe: "org.openrewrite.java.spring.boot2.ReplaceEJBWithSpring"
              options:
                source-patterns:
                  - "CustomJdbcWrapper"
                  - "DatabaseUtil"
                  - "JdbcHelper"
                target-pattern: "@Autowired ${dao_name}"
                
            - type: "COMMAND"
              name: "compile-new-daos"
              description: "Compile the new DAO classes"
              command: |
                cd ${project_root}/semeru-springboot && mvn compile
              working-directory: "${project_root}"
              timeout-seconds: 180
              
            - type: "AI_PROMPT"
              name: "generate-dao-unit-tests"
              description: "Generate unit tests for DAOs"
              prompt: |
                Generate comprehensive unit tests for the migrated DAO classes.
                
                ## Generated DAOs:
                ${generated_daos}
                
                Create JUnit 5 tests that:
                1. Use @SpringBootTest for integration testing
                2. Use @Transactional for test isolation
                3. Test all CRUD operations
                4. Test edge cases (not found, duplicates)
                5. Verify SQL query execution
                6. Test batch operations if present
                
                Use embedded H2 database for testing.
                Provide complete test classes.
              output-variable: "dao_unit_tests"
              temperature: 0.2
              max-tokens: 3000
              
            - type: "FILE_OPERATION"
              name: "create-dao-tests"
              description: "Create DAO test classes"
              operation: "CREATE_MULTIPLE"
              files: "${dao_unit_tests}"
              base-path: "${project_root}/semeru-springboot/src/test/java/${package_base_path}/dao"
              
            - type: "COMMAND"
              name: "run-dao-tests"
              description: "Execute DAO unit tests"
              command: |
                cd ${project_root}/semeru-springboot && mvn test -Dtest="*Dao*"
              working-directory: "${project_root}"
              timeout-seconds: 300
              capture-output: true
              
            - type: "INTERACTIVE_VALIDATION"
              name: "verify-jdbc-migration"
              description: "Verify JDBC wrapper migration"
              validation-type: "MANUAL_CONFIRM"
              message: |
                JDBC wrapper migration completed.
                
                - Spring JdbcTemplate DAOs generated
                - All SQL queries preserved
                - Calling code refactored
                - Unit tests created
                - Tests executed
                
                Verify:
                1. All wrapper classes replaced
                2. DAOs compile successfully
                3. Unit tests pass
                4. No JDBC connection leaks
                5. Transaction management works
                
                Phase 2 (JDBC Migration) complete!
                Proceed to Phase 2B (Entity Bean Migration)?
              required: true
              timeout-seconds: 1800
