# Phases 9-10: Modernization - JDK Upgrade and Antipatterns
# JDK 8â†’21 Migration + Legacy Code Refactoring
# Tasks: 900-902, 1000-1004

migration-plan:
  phases:
    - id: "phase-9"
      name: "JDK Version Upgrade (8 â†’ 21)"
      description: "Incremental JDK upgrade path with library compatibility"
      
      tasks:
        - id: "task-900"
          name: "Analyze Library Compatibility"
          pattern-tag: "LIBRARY_COMPATIBILITY_ANALYSIS"
          blocks:
            - type: "MAVEN"
              name: "list-dependencies"
              description: "Generate dependency tree for JDK compatibility analysis"
              goals: "dependency:tree"
              java-home: "${maven_java_home}"
              maven-home: "${maven_home}"
              working-directory: "${project_root}/semeru-springboot"
              timeout-seconds: 120
              
            - type: "AI_PROMPT"
              name: "analyze-jdk-compatibility"
              prompt: |
                Analyze library compatibility for JDK upgrade (8â†’11â†’17â†’21).
                
                Create upgrade matrix showing:
                1. Libraries requiring updates for each JDK version
                2. Breaking changes to watch for
                3. Removed JDK APIs (Java EE modules in JDK 11, Security Manager in JDK 17)
                4. Spring Boot version requirements (2.7.x for JDK 8-11, 3.x for JDK 17+)
                
                Provide step-by-step upgrade path.
              output-variable: "jdk_compatibility_analysis"
              temperature: 0.2
              max-tokens: 2500
              
            - type: "FILE_OPERATION"
              name: "create-jdk-upgrade-plan"
              operation: "CREATE"
              path: "${project_root}/docs/migration/JDK_UPGRADE_PLAN.md"
              content: |
                # JDK Upgrade Plan
                
                ${jdk_compatibility_analysis}
                
                ## Recommended Path
                JDK 8 â†’ JDK 11 (test) â†’ JDK 17 (test) â†’ JDK 21 (final)
                
        - id: "task-901"
          name: "Update JDK APIs and Language Features"
          pattern-tag: "JDK_API_UPDATES"
          blocks:
            - type: "FILE_OPERATION"
              name: "update-java-version"
              operation: "REPLACE"
              path: "${project_root}/semeru-springboot/pom.xml"
              search: "<java.version>8</java.version>"
              replace: "<java.version>17</java.version>"
              
            - type: "AI_PROMPT"
              name: "identify-deprecated-apis"
              prompt: |
                Identify deprecated/removed JDK APIs in codebase.
                
                Check for:
                - Java EE modules (JAXB, JAX-WS) - removed in JDK 11
                - Security Manager usage - removed in JDK 17+
                - Finalization (finalize()) - deprecated
                - Thread.stop/destroy - deprecated
                
                Provide replacement strategies.
              output-variable: "deprecated_api_analysis"
              temperature: 0.2
              max-tokens: 2000
              
            - type: "FILE_OPERATION"
              name: "document-api-changes"
              operation: "CREATE"
              path: "${project_root}/docs/migration/JDK_API_CHANGES.md"
              content: "${deprecated_api_analysis}"
              
        - id: "task-902"
          name: "Upgrade to Spring Boot 3.x (Jakarta EE)"
          pattern-tag: "SPRING_BOOT_VERSION_UPGRADE"
          blocks:
            - type: "FILE_OPERATION"
              name: "update-spring-boot-version"
              operation: "REPLACE"
              path: "${project_root}/semeru-springboot/pom.xml"
              search: "<version>2.7.18</version>"
              replace: "<version>3.2.1</version>"
              
            - type: "COMMAND"
              name: "replace-javax-with-jakarta"
              description: "Mass replace javax.* with jakarta.*"
              command: |
                cd ${project_root}/semeru-springboot/src && \
                find . -name "*.java" -exec sed -i 's/import javax\.servlet/import jakarta.servlet/g' {} + && \
                find . -name "*.java" -exec sed -i 's/import javax\.persistence/import jakarta.persistence/g' {} + && \
                find . -name "*.java" -exec sed -i 's/import javax\.validation/import jakarta.validation/g' {} + && \
                find . -name "*.java" -exec sed -i 's/import javax\.annotation/import jakarta.annotation/g' {} +
              working-directory: "${project_root}"
              timeout-seconds: 120
              
            - type: "MAVEN"
              name: "compile-with-jdk17"
              description: "Compile with JDK 17+ after Jakarta namespace migration"
              goals: "clean compile"
              java-home: "${maven_java_home}"
              maven-home: "${maven_home}"
              working-directory: "${project_root}/semeru-springboot"
              timeout-seconds: 300
              
            - type: "INTERACTIVE_VALIDATION"
              name: "verify-jdk-upgrade"
              validation-type: "MANUAL_CONFIRM"
              message: |
                JDK Upgrade Complete!
                - JDK 17+ configured
                - Spring Boot 3.x configured
                - javax.* â†’ jakarta.* completed
                - Compilation successful
                
                Proceed to Phase 10 (Antipatterns)?
              required: true
              timeout-seconds: 1800
              
    - id: "phase-10"
      name: "Legacy Code Refactoring (Antipatterns)"
      description: "Refactor common legacy antipatterns to modern patterns"
      
      tasks:
        - id: "task-1000"
          name: "Refactor Deep Inheritance Hierarchies"
          pattern-tag: "DEEP_INHERITANCE_REFACTORING"
          blocks:
            - type: "GRAPH_QUERY"
              name: "query-deep-inheritance"
              description: "Query for classes with deep inheritance (tagged by InheritanceDepthInspector)"
              query-type: "BY_TAGS"
              tags:
                - "inheritance.is_deep"
              output-variable: "deep_inheritance_nodes"
              
            - type: "AI_PROMPT_BATCH"
              name: "suggest-composition-refactoring"
              items-variable: "deep_inheritance_nodes"
              prompt-template: |
                Analyze deep inheritance hierarchy.
                
                Class: ${current_item.fullyQualifiedName}
                Package: ${current_item.packageName}
                Inheritance Depth: ${current_item.properties.inheritance.depth}
                Superclass: ${current_item.properties.inheritance.superclass_fqn}
                Root Class: ${current_item.properties.inheritance.root_class}
                
                Suggest refactoring to composition over inheritance where:
                - Extract common functionality into composed components
                - Use interfaces for capabilities
              output-variable: "composition_suggestions"
              temperature: 0.2
              max-tokens: 1500
              parallel: false
              
            - type: "FILE_OPERATION"
              name: "document-refactoring"
              operation: "CREATE"
              path: "${project_root}/docs/migration/INHERITANCE_REFACTORING.md"
              content: "${composition_suggestions}"
              
        - id: "task-1001"
          name: "Modernize Singleton Pattern"
          pattern-tag: "SINGLETON_MODERNIZATION"
          blocks:
            - type: "GRAPH_QUERY"
              name: "query-singletons"
              description: "Query for singleton patterns (tagged by SingletonPatternInspector)"
              query-type: "BY_TAGS"
              tags:
                - "antipattern.singleton.detected"
              output-variable: "singleton_nodes"
              
            - type: "AI_PROMPT_BATCH"
              name: "convert-to-spring-beans"
              items-variable: "singleton_nodes"
              prompt-template: |
                Convert manual Singleton to Spring @Component.
                
                Class: ${current_item.fullyQualifiedName}
                Package: ${current_item.packageName}
                Type: ${current_item.properties.antipattern.singleton.info.type}
                Thread-safe: ${current_item.properties.antipattern.singleton.info.isThreadSafe}
                Has State: ${current_item.properties.antipattern.singleton.info.hasState}
                getInstance Method: ${current_item.properties.antipattern.singleton.info.getInstanceMethodName}
                
                Replace getInstance() with Spring DI.
                Make thread-safe by letting Spring manage lifecycle.
              output-variable: "spring_singletons"
              temperature: 0.2
              max-tokens: 1000
              parallel: false
              
        - id: "task-1002"
          name: "Decompose God Classes"
          pattern-tag: "GOD_CLASS_DECOMPOSITION"
          blocks:
            - type: "COMMAND"
              name: "find-large-classes"
              command: "find ${project_root}/semeru-springboot/src -name '*.java' -exec wc -l {} + | sort -rn | head -20"
              working-directory: "${project_root}"
              timeout-seconds: 60
              capture-output: true
              output-variable: "large_classes"
              
            - type: "AI_PROMPT"
              name: "suggest-decomposition"
              prompt: |
                Analyze large classes (>1000 lines).
                ${large_classes}
                
                Suggest decomposition strategies:
                1. Extract related methods into separate services
                2. Identify cohesive responsibilities
                3. Create focused, single-purpose classes
              output-variable: "decomposition_plan"
              temperature: 0.2
              max-tokens: 2000
              
            - type: "FILE_OPERATION"
              name: "document-decomposition"
              operation: "CREATE"
              path: "${project_root}/docs/migration/GOD_CLASS_REFACTORING.md"
              content: "${decomposition_plan}"
              
        - id: "task-1003"
          name: "Refactor Static Utility Classes"
          pattern-tag: "STATIC_UTILITY_REFACTORING"
          blocks:
            - type: "GRAPH_QUERY"
              name: "query-utility-classes"
              description: "Query for utility classes (tagged by UtilityClassInspector)"
              query-type: "BY_TAGS"
              tags:
                - "antipattern.utilityClass"
              output-variable: "utility_class_nodes"
              
            - type: "AI_PROMPT_BATCH"
              name: "modernize-utilities"
              items-variable: "utility_class_nodes"
              prompt-template: |
                Identify if this utility class should become Spring @Component.
                
                Class: ${current_item.fullyQualifiedName}
                Package: ${current_item.packageName}
                Static Methods: ${current_item.properties.antipattern.utility.info.staticMethodCount}
                Has Utility Naming: ${current_item.properties.antipattern.utility.info.hasUtilityNaming}
                
                Keep static for:
                - Pure functions (no state, no dependencies)
                - Simple transformations
                
                Convert to @Component for:
                - Classes with dependencies
                - Classes with complex logic requiring testing
              output-variable: "utility_refactoring"
              temperature: 0.2
              max-tokens: 1500
              parallel: false
              
        - id: "task-1004"
          name: "Modernize Exception Handling"
          pattern-tag: "CHECKED_EXCEPTION_MODERNIZATION"
          blocks:
            - type: "GRAPH_QUERY"
              name: "query-exception-antipatterns"
              description: "Query for exception antipatterns (tagged by ExceptionAntipatternInspector)"
              query-type: "BY_TAGS"
              tags:
                - "antipattern.exception.generic"
              output-variable: "exception_antipattern_nodes"
              
            - type: "AI_PROMPT_BATCH"
              name: "suggest-exception-modernization"
              items-variable: "exception_antipattern_nodes"
              prompt-template: |
                Modernize exception handling in this class.
                
                Class: ${current_item.fullyQualifiedName}
                Package: ${current_item.packageName}
                Generic Throws: ${current_item.properties.antipattern.exception.info.genericThrows}
                Generic Catches: ${current_item.properties.antipattern.exception.info.genericCatches}
                Empty Catch Blocks: ${current_item.properties.antipattern.exception.info.emptyCatchBlocks}
                Total Violations: ${current_item.properties.antipattern.exception.info.totalViolations}
                
                Strategies:
                1. Replace throws Exception with specific exception types
                2. Replace catch(Exception) with specific exception types
                3. Add proper logging/handling for empty catch blocks
                4. Use runtime exceptions for unexpected errors
                5. Use Optional<T> for missing values
              output-variable: "exception_modernization"
              temperature: 0.2
              max-tokens: 1500
              parallel: false
              
            - type: "FILE_OPERATION"
              name: "create-global-exception-handler"
              operation: "CREATE"
              path: "${project_root}/semeru-springboot/src/main/java/${package_base_path}/exception/GlobalExceptionHandler.java"
              content: |
                package ${package_base}.exception;
                
                import org.springframework.http.HttpStatus;
                import org.springframework.http.ResponseEntity;
                import org.springframework.web.bind.annotation.ControllerAdvice;
                import org.springframework.web.bind.annotation.ExceptionHandler;
                
                @ControllerAdvice
                public class GlobalExceptionHandler {
                    
                    @ExceptionHandler(RuntimeException.class)
                    public ResponseEntity<ErrorResponse> handleRuntimeException(RuntimeException ex) {
                        ErrorResponse error = new ErrorResponse(
                            HttpStatus.INTERNAL_SERVER_ERROR.value(),
                            ex.getMessage(),
                            System.currentTimeMillis()
                        );
                        return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(error);
                    }
                    
                    @ExceptionHandler(IllegalArgumentException.class)
                    public ResponseEntity<ErrorResponse> handleBadRequest(IllegalArgumentException ex) {
                        ErrorResponse error = new ErrorResponse(
                            HttpStatus.BAD_REQUEST.value(),
                            ex.getMessage(),
                            System.currentTimeMillis()
                        );
                        return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(error);
                    }
                }
                
                class ErrorResponse {
                    private int status;
                    private String message;
                    private long timestamp;
                    
                    public ErrorResponse(int status, String message, long timestamp) {
                        this.status = status;
                        this.message = message;
                        this.timestamp = timestamp;
                    }
                    
                    // Getters
                    public int getStatus() { return status; }
                    public String getMessage() { return message; }
                    public long getTimestamp() { return timestamp; }
                }
              
            - type: "MAVEN"
              name: "final-compilation"
              description: "Final compilation with JDK 17+ and modernizations"
              goals: "clean compile"
              java-home: "${maven_java_home}"
              maven-home: "${maven_home}"
              working-directory: "${project_root}/semeru-springboot"
              timeout-seconds: 300
              
            - type: "INTERACTIVE_VALIDATION"
              name: "verify-modernization-complete"
              validation-type: "MANUAL_CONFIRM"
              message: |
                ðŸŽ‰ MIGRATION COMPLETE! ðŸŽ‰
                
                All 10 Phases Finished:
                âœ“ Phase 0: Pre-Migration Assessment
                âœ“ Phase 1: Spring Boot Initialization
                âœ“ Phase 2: JDBC Migration
                âœ“ Phase 2B: Entity Bean Migration
                âœ“ Phase 3: Session Bean Migration
                âœ“ Phase 3B: Message-Driven Beans
                âœ“ Phase 3C: EJB Interface Removal
                âœ“ Phase 4-8: Integration & Deployment
                âœ“ Phase 9: JDK Upgrade (8â†’21)
                âœ“ Phase 10: Antipatterns Refactoring
                
                Migration artifacts created:
                - Spring Boot application (JAR)
                - Comprehensive documentation
                - Test suite
                - Deployment scripts
                
                Application is ready for production!
              required: true
              timeout-seconds: 3600
